{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/put-the-content/","result":{"data":{"site":{"siteMetadata":{"title":"K.Iwata's Blog"}},"markdownRemark":{"id":"1ebcf925-9ae6-5ff9-8b12-0718bcd3764f","excerpt":"某日、WordPressサイトSEO対策にて、「サイトマップとは別に読み込ませたいテキストファイルがある。」と依頼がきました。 なんでも、記事が数百あり、それをクロールさせたい。 でもsitemap.xmlに出せないから、動的にurl…","html":"<p>某日、WordPressサイトSEO対策にて、「サイトマップとは別に読み込ませたいテキストファイルがある。」と依頼がきました。</p>\n<p>なんでも、記事が数百あり、それをクロールさせたい。<br>\nでもsitemap.xmlに出せないから、動的にurl生成しテキストファイルを生成して、それを読み込ませていきたい、とのこと。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">// 以下の様なurlが数百とあった\nhttps://example.com/manual/post?id=....</code></pre></div>\n<h2>フックさせたのはいいものの。。</h2>\n<p>さて、どうしようか、と一呼吸おき、考えたのはフックの利用です。</p>\n<p>WordPressにはフック機能があり、例えば記事をアップした時、更新した時、といったタイミングで任意の関数を実行できる便利な機能です。</p>\n<p>こんな感じで実装してみました。</p>\n<div class=\"gatsby-highlight\" data-language=\"php:functions.php\"><pre class=\"language-php:functions.php\"><code class=\"language-php:functions.php\">&lt;?php\nadd_action( &#39;save_post&#39;, &#39;save_post_urls&#39; );\nfunction save_post_urls($post_ID) {\n    $post_type = get_post_type( $post_ID );\n    if ($post_type === &quot;manual_page&quot;) {\n        // foreachやらなんやらしてpost記事を取得\n        ...\n        // ここに整ったurlたちの文字列が入っている\n        $post_urls = ...;\n        $file_path = ...;\n        file_put_contents($file_path, $post_urls, LOCK_EX);\n}</code></pre></div>\n<p>よし、できた！も束の間、見事にできていませんでした。</p>\n<h2>何がまちがっていたのか？</h2>\n<h3>そもそもパス、合っているか？</h3>\n<p><code class=\"language-text\">$file_path</code>はサーバールートからのフルパスになります。<br>\nサイトのドメインからみていませんか？</p>\n<p>サーバーパスが不明な場合は以下の構文を試したいファイルに記述してみるといいです。</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">;</span> <span class=\"token delimiter important\">?></span></span></code></pre></div>\n<p>そうしたら、画面にパス情報が出力されます。</p>\n<h3>許可、されてる？</h3>\n<p>これは結構盲点ではないでしょうか。いわゆるパーミッションっていうやつです。<br>\n「ファイル書き込み、読み込み、実行をしていーよー」っていう許可です。</p>\n<p><code class=\"language-text\">file_put_contents</code>関数がfileがあったら上書きしたり、なかったら新しく生成するような関数なんですが、それにもサーバー側の許可が必要です。</p>\n<p>この許可がないと、見事に反映されないので要注意です。</p>\n<h2>結果</h2>\n<p>しっかり生成、書き足し等できる状態に出来上がりました。</p>\n<p>関数は便利ですが、そうしたセキュリティー面であったりも気を配らなければ、とより一層気を引き締める１日でした。</p>","frontmatter":{"title":"put_the_contentsでハマった話","date":"December 01, 2020","description":"put_the_contentsでハマった話の共有です。"}}},"pageContext":{"slug":"/put-the-content/","previous":null,"next":{"fields":{"slug":"/daily-policy/"},"frontmatter":{"title":"日記みたいなもの"}}}},"staticQueryHashes":["3534452819","984448874"]}