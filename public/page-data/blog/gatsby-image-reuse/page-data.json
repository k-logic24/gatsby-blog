{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/blog/gatsby-image-reuse/","result":{"data":{"site":{"siteMetadata":{"title":"K.Iwata's BLOG"}},"markdownRemark":{"id":"81489456-4d91-5642-bd00-d6ee0336a848","excerpt":"前提 1 ページに複数の画像があり、 全て webp…","html":"<h2 id=\"前提\">前提</h2>\n<p>1 ページに複数の画像があり、<br>\n全て webp 対応して、<br>\nかつ使いまわしたい。</p>\n<h2 id=\"律儀に\">律儀に</h2>\n<p>まずテンプレを持ってくる。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">gatsby-starter-default@0.1.0 develop /Users/goqsystem_77/Desktop/my-gatsby-project\n\n// インストール後\n<span class=\"token function\">yarn</span> start</code></pre></div>\n<p>さて、お出迎えするのは見慣れた宇宙服のおっさん。</p>\n<p><code class=\"language-text\">src/components/image.js</code>をみてみるとこんなコードが書いてあります。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx:src/components/image.js\"><pre class=\"language-jsx:src/components/image.js\"><code class=\"language-jsx:src/components/image.js\">import React from &quot;react&quot;\nimport { useStaticQuery, graphql } from &quot;gatsby&quot;\nimport Img from &quot;gatsby-image&quot;\n\nconst Image = () =&gt; {\n  const data = useStaticQuery(graphql`\n    query {\n      placeholderImage: file(relativePath: { eq: &quot;gatsby-astronaut.png&quot; }) {\n        childImageSharp {\n          fluid(maxWidth: 300) {\n            ...GatsbyImageSharpFluid\n          }\n        }\n      }\n    }\n  `)\n\n  if (!data?.placeholderImage?.childImageSharp?.fluid) {\n    return &lt;div&gt;Picture not found&lt;/div&gt;\n  }\n\n  return &lt;Img fluid={data.placeholderImage.childImageSharp.fluid} /&gt;\n}\n\nexport default Image</code></pre></div>\n<p><code class=\"language-text\">gatsby-astronaut.png</code>を検索し、その画像を引っ張ってきているだけですね。<br>\nファイル名を決め打ちしてますから、もちろん使いまわせるはずもありません。</p>\n<h2 id=\"webp-対応\">webp 対応</h2>\n<p>まず、上記だと webp が出力ができてません。対応します。<br>\nといっても Fragment 名を変えるのみです。</p>\n\n        <div class=\"gatsby-code-title md-label\">\n          <span>src/components/image.js</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token operator\">...</span>\nquery <span class=\"token punctuation\">{</span>\n  placeholderImage<span class=\"token operator\">:</span> <span class=\"token function\">file</span><span class=\"token punctuation\">(</span>relativePath<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> eq<span class=\"token operator\">:</span> <span class=\"token string\">\"gatsby-astronaut.png\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    childImageSharp <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">fluid</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">maxWidth<span class=\"token operator\">:</span> <span class=\"token number\">300</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span>GatsbyImageSharpFluid_withWebp\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token operator\">...</span></code></pre></div>\n<p>これで OK です。</p>\n<h3 id=\"fragment\">fragment</h3>\n<p>Gatsby には<code class=\"language-text\">Fragment</code>という機能がありまして、任意のフィールドをまとめることができるんですね。<br>\n今回だと、<code class=\"language-text\">GatsbyImageSharpFluid_withWebp</code>は以下のように展開されます。</p>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token keyword\">fragment</span> <span class=\"token fragment function\">GatsbyImageSharpFluid_withWebp</span> <span class=\"token keyword\">on</span> <span class=\"token class-name\">ChildImageSharp</span> <span class=\"token punctuation\">{</span>\n  base64\n  aspectRatio\n  src\n  srcSetWebp\n  srcWebp\n  srcSet\n  sizes\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>このフラグメントですが、どこで定義されたのかというと、<code class=\"language-text\">gatsby-transformer-sharp</code>プラグインによって定義されています。<br>\nこれはプロジェクトにデフォルトでインストールされています。</p>\n<p>以下はドキュメントです。<br>\n<a href=\"https://www.gatsbyjs.com/plugins/gatsby-image/#fragments\">https://www.gatsbyjs.com/plugins/gatsby-image/#fragments</a></p>\n<h2 id=\"props-で受け取る\">props で受け取る</h2>\n<p>webp 対応はできました。では使いまわしです。<br>\n結論、以下のように書き換えます。</p>\n\n        <div class=\"gatsby-code-title md-label\">\n          <span>src/components/image.js</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Image</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> assetUrl<span class=\"token punctuation\">,</span> alt <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> allImageSharp <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useStaticQuery</span><span class=\"token punctuation\">(</span>graphql<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n    query {\n      allImageSharp {\n        nodes {\n          fluid(maxWidth: 300) {\n            originalName\n            ...GatsbyImageSharpFluid_withWebp\n          }\n        }\n      }\n    }\n  </span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>Img fluid<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>allImageSharp<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">n</span> <span class=\"token operator\">=></span> n<span class=\"token punctuation\">.</span>fluid<span class=\"token punctuation\">.</span>originalName <span class=\"token operator\">===</span> assetUrl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>fluid<span class=\"token punctuation\">}</span> alt<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>alt<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>query に<code class=\"language-text\">originalName</code>を追加しました。これはファイル名を取得するフィールドです。<br>\nprops に assetUrl と alt を設定しました。使用側でデータを渡して、受け取ります。</p>\n<p>あとは、find メソッドで originalName と assetUrl が一致するものをフィルタリングし、fluid にアクセスします。</p>\n<p>使用側は以下のようにします。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token operator\">&lt;</span>Image assetUrl<span class=\"token operator\">=</span><span class=\"token string\">\"....png\"</span> alt<span class=\"token operator\">=</span><span class=\"token string\">\"...\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span></code></pre></div>\n<p>おじさまだけではつまらないでしょうから、猫を追加しました。</p>\n\n        <div class=\"gatsby-code-title md-label\">\n          <span>src/pages/index.js</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">style</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> maxWidth<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">300px</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> marginBottom<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">1.45rem</span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Image</span></span> <span class=\"token attr-name\">assetUrl</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">'</span>gatsby-astronaut.png<span class=\"token punctuation\">'</span></span> <span class=\"token attr-name\">alt</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">'</span>astronaut<span class=\"token punctuation\">'</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">style</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> maxWidth<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">300px</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> marginBottom<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">1.45rem</span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Image</span></span> <span class=\"token attr-name\">assetUrl</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">'</span>neko.jpg<span class=\"token punctuation\">'</span></span> <span class=\"token attr-name\">alt</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">'</span>neko<span class=\"token punctuation\">'</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a9326dd6fd94d38b6689f616084cb806/e35ec/result-gatsby-image.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 139.24050632911394%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAYAAABh2p9gAAAACXBIWXMAAAsTAAALEwEAmpwYAAAD60lEQVRIx41V3VMaVxT3X2sf2ulL04c26UMfmplOX5q3Ttun2JjkoY0TYZrYJIOxjAlQKgKKEgGNIKB8SYAswoqoCBTkQxcE+dhdft0PIXxqz8ydc3fv3t/+fufcc+4YOGu1WrwDwzBoNBodX6/X0Ww2O3Oapjuje5/oxflY98L5+Tmy2SxOT09xcnKCdDqNfD6PTCYjzHO5nDCKhWIP0EhAnkmlUkG5XBYGRVHCT0qlEqgShWKxyL07Q/Wiira197ZtbNTCKGM5tRflBmrV+vWSeT8wWEbwLMMKmxq1JizyALa0UeSOqQ/7ugE7oK0P8xbLA7af2Q5Dt4HEq3ErDNNekJ60yJrtA+yW2yudwdneDtwrcUSt70Dn3uPVPQcmbqhRKopxFH/cJ7kfjG7QOCZLXNpjIF4+hFkRg2FyCfuGv7ChJqGTbCNF5i/D0EtiALC9GHSkEPxHC9eMHG9mQzDJthHQW2BTh7GzGhMA+/cMALYl8Fah6jC+8MF89ydopS6s/DaHxbtP4bWkMEzVSIb9H1E+BRQPXXDOKJB7t4amoLLVFTtcw/BysR0f+8I+J5OA4U8/znK1TlZ75V4D2B2XlWdeVEt1RFxJIXadY9J19kZK7mdZLl7A9jchzK0qAmHncRfg8EoaWSltm/1lHcloAbvOpMB0WEV1YwwBZAXPXMbQodnFQTArHnOa7QNjhwNe1RwqVAPNBntlwxjIcrtW08kYHOvzCHjXEAtvIxHzI3kYQjpB4DAWALnrRZRwgwg6EdyxweM0opBPDzJkWREw8n4bCtk9aF5L8IfkV0xM/Izn079DOvUA+gU5PA4jNte02DCpYTLIsaCQ4PgoclkQ7CBgLLKDRZUEKvkUpibHIZU8wEeffoxPbnyOL259iaUlDfxenpkZzg0dLBxoJhXv6Ug9gHHSD73yMayrr+G16xFyG/Ht7Zv46puv8d2d7zGnnANBBOFx2+C0LsJ8HSBJuKCUjcOoeQrz0iycb+fx6P4d3Lz1GZ7JpmEy6eHzWLG1aYDNooZR+0KI+5WAqhke8AnWl2dhX1PDblHiyeSPUM5J4XebObnL2LJqYTOr8Eb/HP+mhgIywgPht0H2+Ado5PexMi/F2vJLjokKbrsO7k0dB6SD462GS4oCJk7BgmKSS8ruYFLaKS/kEgj6Vjmmdi6eHhzFA0jECSQOI0gekUgm9jgAEomDMA5iIUTDLpSowrBKEVsS3QR3sfMXPte1aZ75/7oIhx1s8UUuyyAcbCAcasLnaiC+R6NWY1GtsKics7ioskJb4+PFx50fV9YydcpyUhhk0qLfJ8URDjII+WnEokxPLxxm/wHJESI+qbLxUQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"result gatsby image\"\n        title=\"result gatsby image\"\n        src=\"/static/a9326dd6fd94d38b6689f616084cb806/f058b/result-gatsby-image.png\"\n        srcset=\"/static/a9326dd6fd94d38b6689f616084cb806/c26ae/result-gatsby-image.png 158w,\n/static/a9326dd6fd94d38b6689f616084cb806/6bdcf/result-gatsby-image.png 315w,\n/static/a9326dd6fd94d38b6689f616084cb806/f058b/result-gatsby-image.png 630w,\n/static/a9326dd6fd94d38b6689f616084cb806/e35ec/result-gatsby-image.png 861w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2 id=\"感想\">感想</h2>\n<p>いちいちクエリを作成するのではなく、再利用性があるととても幸せなことに気づきました。</p>","frontmatter":{"title":"Gatsby-Imageコンポーネント化して使い回す方法","date":"December 02, 2020","description":"Gatsby-Imageを再利用する方法を紹介します。","hero":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAwAC/8QAFwEAAwEAAAAAAAAAAAAAAAAAAAECBP/aAAwDAQACEAMQAAABIyzopYof/8QAGxAAAgEFAAAAAAAAAAAAAAAAAQIAAxAREhP/2gAIAQEAAQUCehqvJoUYTJN//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGBAAAgMAAAAAAAAAAAAAAAAAARASITH/2gAIAQEABj8CBkLev//EABsQAQADAAMBAAAAAAAAAAAAAAEAETEQIZGh/9oACAEBAAE/IUtxVVO/D2KUn2JAUhhfG7P/2gAMAwEAAgADAAAAEFTv/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFxEBAQEBAAAAAAAAAAAAAAAAAQAhUf/aAAgBAgEBPxAHtt//xAAcEAEBAQABBQAAAAAAAAAAAAABEQAhMUFRgaH/2gAIAQEAAT8QDgSwyLqgJKAsX086IY9uPP3datRQavlysVYQu//Z","aspectRatio":1.5,"src":"/static/375dde6c6e620ddcc569377d34d41883/9842e/gatsby.jpg","srcSet":"/static/375dde6c6e620ddcc569377d34d41883/07ab6/gatsby.jpg 225w,\n/static/375dde6c6e620ddcc569377d34d41883/32fd5/gatsby.jpg 450w,\n/static/375dde6c6e620ddcc569377d34d41883/9842e/gatsby.jpg 900w","srcWebp":"/static/375dde6c6e620ddcc569377d34d41883/210c1/gatsby.webp","srcSetWebp":"/static/375dde6c6e620ddcc569377d34d41883/975bf/gatsby.webp 225w,\n/static/375dde6c6e620ddcc569377d34d41883/b8a88/gatsby.webp 450w,\n/static/375dde6c6e620ddcc569377d34d41883/210c1/gatsby.webp 900w","sizes":"(max-width: 900px) 100vw, 900px"}}}},"tableOfContents":"<ul>\n<li><a href=\"#%E5%89%8D%E6%8F%90\">前提</a></li>\n<li><a href=\"#%E5%BE%8B%E5%84%80%E3%81%AB\">律儀に</a></li>\n<li>\n<p><a href=\"#webp-%E5%AF%BE%E5%BF%9C\">webp 対応</a></p>\n<ul>\n<li><a href=\"#fragment\">fragment</a></li>\n</ul>\n</li>\n<li><a href=\"#props-%E3%81%A7%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8B\">props で受け取る</a></li>\n<li><a href=\"#%E6%84%9F%E6%83%B3\">感想</a></li>\n</ul>"}},"pageContext":{"slug":"/gatsby-image-reuse/","previous":{"fields":{"slug":"/custom-zsh/"},"frontmatter":{"title":"zshシェルをカスタマイズする方法","tags":["zsh","shell"]}},"next":{"fields":{"slug":"/ts-interface-types/"},"frontmatter":{"title":"今更ながらのTypeとInterfaceの違い","tags":["typescript"]}}}},"staticQueryHashes":["3534452819","984448874"]}